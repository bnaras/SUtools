<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stanford Utility Tools for R packages using Fortran • SUtools</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Stanford Utility Tools for R packages using Fortran">
<meta property="og:description" content="SUtools">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">SUtools</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.5-3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/SUtools.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/bnaras/SUtools/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Stanford Utility Tools for R packages using
Fortran</h1>
                        <h4 data-toc-skip class="author">Balasubramanian
Narasimhan</h4>
            
            <h4 data-toc-skip class="date">2022-11-17</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/bnaras/SUtools/blob/HEAD/vignettes/SUtools.Rmd" class="external-link"><code>vignettes/SUtools.Rmd</code></a></small>
      <div class="hidden name"><code>SUtools.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>There are many important R packages by Stanford authors using Fortran
for speed and efficiency. For example, Jerome Friedman, Trevor Hastie
and Robert Tibshirani have several packages, <a href="https://cran.r-project.org/package=glmnet" class="external-link"><code>glmnet</code></a>,
<a href="https://cran.r-project.org/package=glasso" class="external-link"><code>glasso</code></a>,
<a href="https://cran.r-project.org/package=gam" class="external-link"><code>gam</code></a> to
name a few, that make use of Fortran. The Fortran in many cases is
generated using a preprocessor called Mortran (<code>m77</code>). It is
a bit of a chore to ensure that the generated Fortran code generates no
warnings and registers the native routines as required by CRAN. This
package is an attempt o make it almost automatic.</p>
<p>I’d put together code for this several times over the years but never
quite organized it in one place.</p>
<p>A related package <a href="https://github.com/bnaras/ftest" class="external-link">ftest</a>
provides a complete example of calling back a user-defined R function
from Fortran.</p>
<div class="section level3">
<h3 id="useful-functions-for-general-use">Useful functions for general use<a class="anchor" aria-label="anchor" href="#useful-functions-for-general-use"></a>
</h3>
<p>While this package is directed specifically towards Mortran, there
are several functions that many may find useful.</p>
<ul>
<li><p>The registration function (<code>gen_registration</code>) can be
used for ordinary Fortran to generate registration code automatically.
It only requires the subroutine or function call statement as input; see
<code><a href="../reference/gen_registration.html">?gen_registration</a></code>.</p></li>
<li><p>The function <code>fix_unused_labels</code> can be used to
automatically fix unused label warnings that are generated by CRAN flags
for Fortran.</p></li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="example">Example<a class="anchor" aria-label="anchor" href="#example"></a>
</h2>
<p>We will use an example package <code>pcLasso</code> which has a
Mortran file (included in this package) that is used for the actual
computations along a path of values for <span class="math inline">\(\lambda\)</span>.</p>
<p>If all goes well, only one real function call is needed to generate
both the Fortran and registration code.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://bnaras.github.io/SUtools" class="external-link">SUtools</a></span><span class="op">)</span></span>
<span><span class="va">mortran_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"misc"</span>, <span class="st">"pcLasso.m"</span>, package <span class="op">=</span> <span class="st">"SUtools"</span><span class="op">)</span></span>
<span><span class="va">result</span>  <span class="op">&lt;-</span> <span class="fu"><a href="../reference/process_mortran.html">process_mortran</a></span><span class="op">(</span>input_mortran_file <span class="op">=</span> <span class="va">mortran_file</span>,</span>
<span>                           pkg_name <span class="op">=</span> <span class="st">"pcLasso"</span>,</span>
<span>                           control <span class="op">=</span> <span class="fu"><a href="../reference/sutools_control.html">sutools_control</a></span><span class="op">(</span>fix_allocate <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Processing Mortran: reading file</span></span>
<span><span class="co">## Processing Mortran: fixing allocate statements</span></span>
<span><span class="co">## Processing Mortran: inserting implicit statements</span></span>
<span><span class="co">## Processing Mortran; replacing reals by double precision</span></span>
<span><span class="co">## Checking for long lines; can cause problems downstream if not fixed</span></span>
<span><span class="co">##   Note: Some lines could become longer, &gt; 72 cols in %FORTRAN sections</span></span>
<span><span class="co">##         and &gt; 80 cols in MORTRAN sections as a result of 'real' being</span></span>
<span><span class="co">##         replaced by 'double precision'. Split such lines into two;</span></span>
<span><span class="co">##         in %FORTRAN sections, use a continuation character in col 6.</span></span>
<span><span class="co">## Seems ok, continuing</span></span>
<span><span class="co">## Generating Fortran from Mortran</span></span>
<span><span class="co">## Checking Fortran</span></span>
<span><span class="co">## Chopping Lines at 72 cols</span></span>
<span><span class="co">## Running gfortran to detect warning lines on unused labels</span></span>
<span><span class="co">## Scanning gfortran output for warnings on unusued labels</span></span>
<span><span class="co">## Generating Init function for package pcLasso</span></span></code></pre>
<p>This will return a list of three items: a cleaned-up version of the
mortran named <code>mortran</code>, the corresponding cleaned and
processed fortran named <code>fortran</code>, and registration C code
named <code>pcLasso_init.c</code> where the name is constructed from the
package name provided. The fortran and the registration code can be
saved in appropriate files in <code>pcLasso/src</code> simply by using
<code><a href="https://rdrr.io/r/base/writeLines.html" class="external-link">base::writeLines</a></code>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/writeLines.html" class="external-link">writeLines</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">fortran</span>, <span class="st">"pcLasso/src/pcLasso.f"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/writeLines.html" class="external-link">writeLines</a></span><span class="op">(</span><span class="va">result</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"pcLasso/src/"</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a>
</h2>
<p>The <code>process_mortran</code> function goes through several
steps.</p>
<ol style="list-style-type: decimal">
<li>First, it fixes the <code>allocate</code> statements in the Mortran
file. (This step is skipped if the option <code>fix_allocate</code> is
<code>FALSE</code>, the default!) Lines of the type:</li>
</ol>
<pre><code><span><span class="fu">allocate</span><span class="op">(</span><span class="fu">a</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">ni</span><span class="op">)</span>,stat<span class="op">=</span><span class="va">ierr</span><span class="op">)</span>;</span></code></pre>
<p>are replaced with</p>
<pre><code><span><span class="fu">allocate</span><span class="op">(</span><span class="fu">a</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">ni</span><span class="op">)</span>,stat<span class="op">=</span><span class="va">jerr</span><span class="op">)</span>; <span class="kw">if</span><span class="op">(</span><span class="va">jerr.ne.0</span><span class="op">)</span> <span class="va">return</span>;</span></code></pre>
<p>ensuring that warnings for the variable <code>jerr</code> being
ignored go away</p>
<ol start="2" style="list-style-type: decimal">
<li>All subroutines and functions in Mortran and Fortran subroutines and
functions are modified to include a</li>
</ol>
<pre><code>      implicit double precision(a-h,o-z)</code></pre>
<p>statement to ensure double precision calculations.</p>
<ol start="3" style="list-style-type: decimal">
<li><p>All <code>real</code> variables are replaced with
<code>double precision</code> variables.</p></li>
<li><p>Constants such as <code>[eE][+-]?[0-9]+.</code> are replaced by
double precision equivalents.</p></li>
<li>
<p>As a result of replacing <code>real</code> with
<code>double precision</code>, there is a possibility for some lines to
go over the 72 character limit, in the Fortran sections. For Mortran,
this limit is 80 characters and that is also checked.</p>
<p>If this check fails, the function exits with a detailed list of
things and approximate line numbers for the user to address.</p>
</li>
<li><p>The Mortran executable is run on the Mortran file to produce the
Fortran file with extension <code>.for</code>.</p></li>
<li><p>There is extraneous stuff that Mortran adds which can again
trigger <code>gfortran</code> warnings. So this step chops off things
beyond 72 columns to yield a <code>.f</code> file.</p></li>
<li><p>Next <code>gfortran</code> is run on the code in the
<code>.f</code> file with flags <code>-Wunusued</code> to detect unused
labels. The output is then scanned for the warning messages.</p></li>
<li><p>If the warning messages pertain only to unusued labels, an
automatic fix is made on the generated Fortran file. Otherwise, an
informative message is printed with hints on how to fix the
source.</p></li>
<li><p>If registration is asked for and a package name is provided, the
registration is code is generated in a file typically named based on the
package, <code>pcLasso_init.c</code> in our example. This is done by
scanning the Mortran file for <code>subroutine</code> declarations (even
if they span several lines) and using implicit Fortran conventions to
generate C registration code.</p></li>
</ol>
</div>
<div class="section level2">
<h2 id="notes">Notes<a class="anchor" aria-label="anchor" href="#notes"></a>
</h2>
<ul>
<li><p>If one provides the package name, registration for all the
subroutines in the mortran file will be generated, <em>even those that
are not called from R</em>. This may not be desirable. One can
selectively generate registration for certain subroutines as is
illustrated in the example for the function
<code>gen_registration</code>.</p></li>
<li><p>Included in this package is a modified version of the mortran
preprocessor which is then used as a utility to automate tasks as much
as possible.</p></li>
<li><p>I am sure this package could be improved. Feel free to make a
PR.</p></li>
</ul>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by <a href="https://naras.web.stanford.edu" class="external-link">Balasubramanian Narasimhan</a>.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
